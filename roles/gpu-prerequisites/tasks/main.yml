---
- name: Remove NVIDIA repository entries from main sources.list
  lineinfile:
    path: /etc/apt/sources.list
    regexp: '.*developer\.download\.nvidia\.com.*'
    state: absent

- name: Remove NVIDIA Container Toolkit entries from main sources.list
  lineinfile:
    path: /etc/apt/sources.list
    regexp: '.*nvidia\.github\.io/libnvidia-container.*'
    state: absent

- name: Remove all NVIDIA-related repository files
  shell: rm -f /etc/apt/sources.list.d/*cuda* /etc/apt/sources.list.d/*nvidia*
  args:
    warn: false

- name: Remove old NVIDIA keyrings
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /usr/share/keyrings/cuda-archive-keyring.gpg
    - /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg
    - /etc/apt/trusted.gpg.d/cuda-archive-keyring.gpg
    - /etc/apt/trusted.gpg.d/nvidia-container-toolkit-keyring.gpg

- name: Update package cache after cleanup
  apt:
    update_cache: yes
  ignore_errors: yes

- name: Install prerequisites for NVIDIA drivers
  apt:
    name:
      - build-essential
      - dkms
      - linux-headers-generic
      - curl
      - gnupg
    state: present

- name: Add NVIDIA CUDA repository key
  shell: |
    curl -fsSL https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2404/x86_64/3bf863cc.pub | gpg --dearmor -o /usr/share/keyrings/cuda-archive-keyring.gpg

- name: Add NVIDIA CUDA repository
  apt_repository:
    repo: "deb [signed-by=/usr/share/keyrings/cuda-archive-keyring.gpg] https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2404/x86_64/ /"
    state: present
    filename: cuda
    update_cache: yes

- name: Add NVIDIA Container Toolkit repository key
  shell: |
    curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg

- name: Get system architecture
  command: dpkg --print-architecture
  register: system_arch
  changed_when: false

- name: Add NVIDIA Container Toolkit repository
  apt_repository:
    repo: "deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://nvidia.github.io/libnvidia-container/stable/deb/{{ system_arch.stdout }} /"
    state: present
    filename: nvidia-container-toolkit
    update_cache: yes

- name: Install NVIDIA driver
  apt:
    name: nvidia-driver-535
    state: present
  register: nvidia_driver_install

- name: Install NVIDIA container toolkit
  apt:
    name: nvidia-container-toolkit
    state: present
    update_cache: yes

- name: Configure containerd for NVIDIA runtime using nvidia-ctk
  shell: nvidia-ctk runtime configure --runtime=containerd
  args:
    creates: /etc/containerd/config.toml.bak
  register: nvidia_ctk_configure

- name: Restart containerd service
  systemd:
    name: containerd
    state: restarted
    enabled: yes
  when: nvidia_ctk_configure.changed

- name: Reboot system if NVIDIA driver was installed
  reboot:
    reboot_timeout: 300
  when: nvidia_driver_install.changed