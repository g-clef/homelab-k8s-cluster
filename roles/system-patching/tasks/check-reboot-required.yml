---
- name: Check if /var/run/reboot-required exists
  stat:
    path: /var/run/reboot-required
  register: reboot_required_file

- name: Set reboot_required fact
  set_fact:
    reboot_required: "{{ reboot_required_file.stat.exists }}"

- name: Check what requires reboot
  command: cat /var/run/reboot-required.pkgs
  register: reboot_required_packages
  when: reboot_required
  changed_when: false
  failed_when: false

- name: Display packages requiring reboot
  debug:
    msg: |
      Reboot required: {{ reboot_required }}
      {% if reboot_required and reboot_required_packages.stdout %}
      Packages that triggered reboot:
      {{ reboot_required_packages.stdout_lines | join('\n') }}
      {% endif %}
  when: reboot_required