---
- name: Add Sealed Secrets Helm repository
  command: helm repo add sealed-secrets https://bitnami-labs.github.io/sealed-secrets
  register: helm_repo_add
  changed_when: '"has been added" in helm_repo_add.stdout'
  failed_when:
    - helm_repo_add.rc != 0
    - '"already exists" not in helm_repo_add.stderr'

- name: Update Helm repositories
  command: helm repo update
  changed_when: false

- name: Install Sealed Secrets Controller using Helm
  command: >
    helm upgrade --install sealed-secrets-controller sealed-secrets/sealed-secrets
    --namespace kube-system
    --version {{ sealed_secrets_chart_version | default('2.15.1') }}
  register: sealed_secrets_install
  changed_when: sealed_secrets_install.rc == 0

- name: Wait for Sealed Secrets Controller to be ready
  command: kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=sealed-secrets -n kube-system --timeout=300s
  register: sealed_secrets_ready
  retries: 5
  delay: 10
  until: sealed_secrets_ready.rc == 0

- name: Display Sealed Secrets status
  debug:
    msg: |
      Sealed Secrets Controller installed successfully!

      The controller is running in the kube-system namespace and will:
      - Automatically decrypt SealedSecret resources into regular Secrets
      - Use cluster-scoped encryption (secrets can be used across namespaces)

      To verify the installation:
      kubectl get pods -n kube-system -l app.kubernetes.io/name=sealed-secrets
      kubectl get services -n kube-system -l app.kubernetes.io/name=sealed-secrets

      To use Sealed Secrets:
      1. Install kubeseal CLI on your local machine:
         - Linux: wget https://github.com/bitnami-labs/sealed-secrets/releases/download/v0.24.0/kubeseal-0.24.0-linux-amd64.tar.gz
         - macOS: brew install kubeseal
         - Windows: choco install kubeseal

      2. Create a regular Kubernetes secret YAML (do not apply it):
         kubectl create secret generic mysecret --dry-run=client --from-literal=password=mypassword -o yaml > mysecret.yaml

      3. Seal the secret using kubeseal:
         kubeseal --controller-name=sealed-secrets-controller --controller-namespace=kube-system < mysecret.yaml > mysealedsecret.yaml

      4. Apply the sealed secret to the cluster:
         kubectl apply -f mysealedsecret.yaml

      5. The controller will automatically decrypt it into a regular Secret that your pods can use.

      IMPORTANT NOTES:
      - The encryption keys are stored in kube-system as Kubernetes Secrets
      - Back up these keys if you need to restore the cluster:
        kubectl get secret -n kube-system -l sealedsecrets.bitnami.com/sealed-secrets-key -o yaml > sealed-secrets-keys.yaml
      - Without the keys, you cannot decrypt existing SealedSecrets
      - Store the backup in a secure location (NOT in git!)

      Documentation: https://github.com/bitnami-labs/sealed-secrets