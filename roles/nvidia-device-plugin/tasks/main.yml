---
- name: Apply NVIDIA device plugin DaemonSet
  shell: kubectl apply -f https://raw.githubusercontent.com/NVIDIA/k8s-device-plugin/v0.14.5/nvidia-device-plugin.yml
  register: device_plugin_apply
  changed_when: '"created" in device_plugin_apply.stdout or "configured" in device_plugin_apply.stdout'

- name: Wait for NVIDIA device plugin daemonset to be created
  shell: kubectl get daemonset nvidia-device-plugin-daemonset -n kube-system
  register: daemonset_check
  retries: 10
  delay: 3
  until: daemonset_check.rc == 0
  changed_when: false

- name: Wait for NVIDIA device plugin pods to be ready
  shell: kubectl wait --for=condition=ready pod -l name=nvidia-device-plugin-ds -n kube-system --timeout=300s
  register: device_plugin_ready
  retries: 3
  delay: 10
  until: device_plugin_ready.rc == 0

- name: Verify GPU resources are available
  shell: kubectl get nodes -o=custom-columns="NODE:.metadata.name,GPU:.status.allocatable.nvidia\.com/gpu"
  register: gpu_resources

- name: Display GPU resources
  debug:
    msg: "GPU resources available on nodes: {{ gpu_resources.stdout_lines }}"

- name: Create example GPU pod manifest
  copy:
    content: |
      apiVersion: v1
      kind: Pod
      metadata:
        name: gpu-test-pod
        namespace: default
      spec:
        restartPolicy: Never
        containers:
        - name: gpu-test
          image: nvidia/cuda:12.6.0-base-ubuntu24.04
          command: ["nvidia-smi"]
          resources:
            limits:
              nvidia.com/gpu: 1
        nodeSelector:
          accelerator: nvidia
        tolerations:
        - key: nvidia.com/gpu
          operator: Exists
          effect: NoSchedule
    dest: /tmp/gpu-test-pod.yaml
    mode: '0644'

- name: Display example GPU pod usage
  debug:
    msg: |
      GPU node setup complete! To test GPU functionality, you can run:
      kubectl apply -f /tmp/gpu-test-pod.yaml
      kubectl logs gpu-test-pod

      To schedule workloads on GPU nodes, use:
      nodeSelector:
        accelerator: nvidia

      Or use node affinity:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: accelerator
                operator: In
                values: ["nvidia"]