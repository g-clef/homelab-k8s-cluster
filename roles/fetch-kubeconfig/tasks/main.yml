---
- name: Check if admin.conf exists on control plane
  stat:
    path: /etc/kubernetes/admin.conf
  register: admin_conf

- name: Fail if cluster is not initialized
  fail:
    msg: "Kubernetes cluster is not initialized. Please run the control-plane playbook first."
  when: not admin_conf.stat.exists

- name: Get local user information
  shell: echo $USER
  delegate_to: localhost
  register: local_user
  run_once: true
  become: no
  changed_when: false

- name: Create local .kube directory
  file:
    path: "{{ lookup('env', 'HOME') }}/.kube"
    state: directory
    mode: '0755'
    owner: "{{ local_user.stdout }}"
  delegate_to: localhost
  run_once: true
  become: no

- name: Fetch kubeconfig from control plane
  fetch:
    src: /etc/kubernetes/admin.conf
    dest: "{{ lookup('env', 'HOME') }}/.kube/config-{{ inventory_hostname }}"
    flat: yes

- name: Set ownership on temporary kubeconfig file
  file:
    path: "{{ lookup('env', 'HOME') }}/.kube/config-{{ inventory_hostname }}"
    owner: "{{ local_user.stdout }}"
    mode: '0600'
  delegate_to: localhost
  become: no
  run_once: true

- name: Read fetched kubeconfig
  slurp:
    src: "{{ lookup('env', 'HOME') }}/.kube/config-{{ inventory_hostname }}"
  delegate_to: localhost
  register: kubeconfig_content
  run_once: true
  become: no

- name: Parse and update kubeconfig with external IP
  copy:
    content: "{{ (kubeconfig_content.content | b64decode) | regex_replace('server: https://.*:6443', 'server: https://' + ansible_host + ':6443') }}"
    dest: "{{ lookup('env', 'HOME') }}/.kube/config"
    mode: '0600'
    owner: "{{ local_user.stdout }}"
  delegate_to: localhost
  run_once: true
  become: no

- name: Remove temporary kubeconfig file
  file:
    path: "{{ lookup('env', 'HOME') }}/.kube/config-{{ inventory_hostname }}"
    state: absent
  delegate_to: localhost
  run_once: true
  become: no

- name: Display kubeconfig location
  debug:
    msg: |
      Kubeconfig has been fetched successfully!

      Location: {{ lookup('env', 'HOME') }}/.kube/config

      You can now use kubectl from your local machine:
        kubectl get nodes
        kubectl get pods -A

      To use a different kubeconfig file:
        export KUBECONFIG={{ lookup('env', 'HOME') }}/.kube/config

      Or specify it in each command:
        kubectl --kubeconfig={{ lookup('env', 'HOME') }}/.kube/config get nodes
  run_once: true